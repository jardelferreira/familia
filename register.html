<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Usuário</title>
    <link rel="stylesheet" href="./css/src/output.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        import { encrypt } from './js/encript.js';

        // Função para fazer requisições JSONP (resolve CORS)
        function makeRequest(action, data = {}) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                // Timeout para evitar requests infinitos
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout na requisição'));
                    cleanup();
                }, 10000);

                const cleanup = () => {
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                    clearTimeout(timeout);
                };

                window[callbackName] = function (response) {
                    resolve(response);
                    cleanup();
                };

                script.onerror = function () {
                    reject(new Error('Erro na requisição'));
                    cleanup();
                };

                const params = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    nocache: Date.now(),
                    ...data
                });

                script.src = `https://script.google.com/macros/s/AKfycbz5Cj8mcYEfHtrGwER4xZEVT_xDe7ov4sth7m3hgaB30-6n-9DqcuZZW5UZyPW1pRhc/exec?${params}`;
                document.head.appendChild(script);
            });
        }

        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                invite_id: params.get('invite_id'),
                expire_at: params.get('expire_at')
            };
        }

        function isLinkExpired(expireAt) {
            const now = new Date();
            const expireDate = new Date(expireAt);
            return now > expireDate;
        }

        function setBotaoEstado(disabled) {
            const bt = document.querySelector("button[type='submit']");
            if (!bt) return;

            bt.disabled = disabled;
            bt.classList.toggle('bg-blue-600', !disabled);
            bt.classList.toggle('hover:bg-blue-700', !disabled);
            bt.classList.toggle('bg-gray-500', disabled);
            bt.classList.toggle('cursor-not-allowed', disabled);

            if (disabled) {
                bt.innerHTML = '<span class="inline-block animate-spin mr-2">⚪</span>Processando...';
            } else {
                bt.innerHTML = 'Registrar';
            }
        }

        function validarCPF(cpf) {
            // Remove caracteres não numéricos
            cpf = cpf.replace(/[^\d]/g, '');

            // Verifica se tem 11 dígitos
            if (cpf.length !== 11) return false;

            // Verifica se todos os dígitos são iguais
            if (/^(\d)\1+$/.test(cpf)) return false;

            return true;
        }

        function formatarCPF(value) {
            // Remove tudo que não é dígito
            value = value.replace(/\D/g, '');

            // Aplica a máscara
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})/, '$1-$2');
            value = value.replace(/(-\d{2})\d+?$/, '$1');

            return value;
        }

        window.addEventListener('DOMContentLoaded', () => {
            const { invite_id, expire_at } = getURLParams();

            if (!invite_id || !expire_at || isLinkExpired(expire_at)) {
                document.getElementById('app').innerHTML = `
                    <div class="text-center mt-20">
                        <div class="mb-4">
                            <svg class="mx-auto h-16 w-16 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-semibold text-red-600 mb-2">Link expirado ou inválido</h2>
                        <p class="text-gray-600">Solicite um novo link de convite para continuar.</p>
                    </div>`;
                return;
            }

            document.getElementById('registro').classList.remove('hidden');

            // Máscara de CPF
            const cpfInput = document.getElementById('cpf');
            cpfInput.addEventListener('input', (e) => {
                e.target.value = formatarCPF(e.target.value);
            });

            document.getElementById('form-registro').addEventListener('submit', async (e) => {
                e.preventDefault();

                const nome = document.getElementById('nome').value.trim();
                const cpfFormatado = document.getElementById('cpf').value.trim();
                const cpf = cpfFormatado.replace(/[^\d]/g, ''); // Remove formatação
                const senha = document.getElementById('senha').value;

                // Validações
                if (!nome || nome.length < 2) {
                    return Swal.fire({
                        icon: 'warning',
                        title: 'Nome inválido',
                        text: 'O nome deve ter pelo menos 2 caracteres.',
                    });
                }

                if (!validarCPF(cpf)) {
                    return Swal.fire({
                        icon: 'warning',
                        title: 'CPF inválido',
                        text: 'Por favor, digite um CPF válido.',
                    });
                }

                if (senha.length < 8) {
                    return Swal.fire({
                        icon: 'warning',
                        title: 'Senha fraca',
                        text: 'A senha deve ter pelo menos 8 caracteres.',
                    });
                }

                // Desativa botão após validação
                setBotaoEstado(true);

                try {
                    // Verifica se CPF já existe usando JSONP
                    console.log('Verificando se CPF já existe...');
                    const usuario = await makeRequest('getUser', { cpf: cpf });

                    if (usuario.success) {
                        setBotaoEstado(false);
                        return Swal.fire({
                            icon: 'error',
                            title: 'CPF já cadastrado',
                            text: 'O CPF informado já está vinculado a um usuário.',
                        });
                    }

                    // Criptografa senha
                    console.log('Criptografando senha...');
                    const senhaCriptografada = await encrypt(senha);

                    // Adiciona usuário usando JSONP
                    console.log('Adicionando usuário...');
                    const resultado = await makeRequest('addUser', {
                        nome: nome,
                        cpf: cpf,
                        senha: senhaCriptografada
                    });

                    setBotaoEstado(false);

                    if (resultado.success) {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Registro concluído!',
                            text: 'Usuário cadastrado com sucesso!',
                            confirmButtonText: 'OK'
                        });

                        // Limpa o formulário
                        document.getElementById('form-registro').reset();
                    } else {
                        throw new Error(resultado.data || 'Erro desconhecido');
                    }

                } catch (error) {
                    console.error("Erro ao registrar:", error);
                    setBotaoEstado(false);

                    Swal.fire({
                        icon: 'error',
                        title: 'Erro ao registrar',
                        text: error.message || 'Não foi possível concluir o registro. Tente novamente mais tarde.',
                        confirmButtonText: 'Tentar novamente'
                    });
                }
            });
        });
    </script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div id="app" class="w-full max-w-md p-6 bg-white shadow-md rounded-xl">
        <div id="registro" class="hidden">
            <div class="text-center mb-6">
                <div class="mx-auto h-4 w-4 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="h-2 w-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Registro de Novo Usuário</h2>
                <p class="text-gray-600 text-sm mt-2">Preencha os dados para criar sua conta</p>
            </div>

            <form id="form-registro" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                    <input type="text" id="nome" required placeholder="Digite seu nome completo"
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                    <input type="text" id="cpf" required maxlength="14" placeholder="000.000.000-00"
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="senha" required placeholder="Mínimo 8 caracteres"
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" />
                    <p class="text-xs text-gray-500 mt-1">Use pelo menos 8 caracteres para maior segurança</p>
                </div>

                <div class="pt-4">
                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-[1.02] focus:ring-4 focus:ring-blue-300 focus:outline-none">
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>

</html>